[View code on GitHub](https://github.com/misbahsy/the-algorithm/src/scala/com/twitter/simclusters_v2/scio/bq_generation/sql/engagement_based_index_generation.sql)

This SQL query generates clusters of top k tweets based on tweet engagements. The engagement type is decided by USER_TWEET_ENGAGEMENT_TABLE_SQL. The query applies a sequence of filters to get eligible tweetIds for tweet embedding generation. The first filter applies a minimum interaction count filter to only generate tweet embeddings for tweets with at least MIN_INTERACTION_COUNT interactions. The second filter applies a minimum favorite count filter. The third filter applies a health and video filter. The final filtered user tweet interaction table is read from the last filter. 

Consumer embeddings are read, and tweet cluster scores are updated based on interaction events. The tweet cluster scores are calculated using a half-life decay formula, where the half-life is set to 8 hours by default but can be changed by setting the HALF_LIFE variable. If the half-life is set to -1, there is no half-life decay, and the sum is directly taken as the score. The tweet embeddings are generated by selecting the top k clusters with the highest normalized scores. The clusters with fewer than MIN_ENGAGEMENT_PER_CLUSTER engagements are filtered out. 

The resulting output is clusters of top k tweets for each cluster key. The top k tweets are sorted by their normalized scores in descending order. The output can be used to identify popular tweets and clusters of tweets based on user engagement. For example, this could be used to recommend tweets to users based on their interests or to identify trending topics on Twitter. 

Example usage:

To generate clusters of top 10 tweets with at least 100 interactions and a minimum favorite count of 10:

```
SELECT *
FROM The_Algorithm_from_Twitter
WHERE CLUSTER_TOP_K_TWEETS = 10
AND MIN_ENGAGEMENT_PER_CLUSTER = 100
AND TWEET_INTERACTION_WITH_FAV_COUNT_FILTER_SQL LIKE '%10%'
```
## Questions: 
 1. What is the purpose of this SQL query?
    
    This SQL query generates a cluster to top k tweets index based on tweet engagements, with the engagement type decided by USER_TWEET_ENGAGEMENT_TABLE_SQL.

2. What are the variables used in this SQL query and what are their default values?
    
    The variables used in this SQL query are halfLife (default: 8 hour halfLife in millis) and currentTs (current timestamp). These variables are defined in the "vars" CTE.

3. What is the criteria for selecting tweets for embedding generation?
    
    The criteria for selecting tweets for embedding generation includes a minimum interaction count filter (tweets with >= MIN_INTERACTION_COUNT interactions), a minimum favorite count filter, and a health and video filter. The final filtered user tweet interaction table is then used to generate tweet embeddings.