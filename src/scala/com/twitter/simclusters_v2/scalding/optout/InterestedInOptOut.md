[View code on GitHub](https://github.com/misbahsy/the-algorithm/src/scala/com/twitter/simclusters_v2/scalding/optout/InterestedInOptOut.scala)

The code in this file is part of the SimClusters_v2 project at Twitter and is responsible for filtering out clusters that users have opted out of. The `filterOptedOutInterestedIn` function takes three arguments: `interestedInPipe`, `optedOutEntities`, and `clusterToEntities`. `interestedInPipe` is a `TypedPipe` of `(UserId, ClustersUserIsInterestedIn)` tuples, where `ClustersUserIsInterestedIn` is a case class containing a map of cluster IDs to scores. `optedOutEntities` is a `TypedPipe` of `(UserId, Set[SemanticCoreEntityId])` tuples, where `SemanticCoreEntityId` is a case class representing a semantic entity. Finally, `clusterToEntities` is a `TypedPipe` of `(ClusterId, Seq[SemanticCoreEntityWithScore])` tuples, where `SemanticCoreEntityWithScore` is a case class representing a semantic entity with a score.

The `filterOptedOutInterestedIn` function first calls `SimClustersOptOutUtil.filterOptedOutClusters` to filter out clusters that users have opted out of. This function takes three arguments: `userToClusters`, `optedOutEntities`, and `legibleClusters`. `userToClusters` is a `Map[UserId, Seq[ClusterId]]` containing the clusters that each user is interested in. `optedOutEntities` is a `Map[UserId, Set[SemanticCoreEntityId]]` containing the semantic entities that each user has opted out of. Finally, `legibleClusters` is a `Map[ClusterId, Seq[SemanticCoreEntityWithScore]]` containing the semantic entities associated with each cluster. The `filterOptedOutClusters` function returns a `Map[UserId, Seq[ClusterId]]` containing the clusters that each user is still interested in after filtering out the opted-out entities.

The `filterOptedOutInterestedIn` function then joins the `interestedInPipe` with the `validInterestedIn` map returned by `filterOptedOutClusters`. It maps over the resulting tuples and filters out the clusters that users have opted out of. Finally, it filters out any tuples where the resulting `ClustersUserIsInterestedIn` object has an empty `clusterIdToScores` map.

The `writeInterestedInOutputExecution` function takes three arguments: `interestedIn`, `interestedInDataset`, and `outputPath`. `interestedIn` is a `TypedPipe` of `(UserId, ClustersUserIsInterestedIn)` tuples. `interestedInDataset` is a `KeyValDALDataset[KeyVal[Long, ClustersUserIsInterestedIn]]`, and `outputPath` is a string representing the HDFS path to write the output to. This function maps over the `interestedIn` pipe to create a `TypedPipe` of `KeyVal[Long, ClustersUserIsInterestedIn]` tuples, then writes the resulting pipe to the `interestedInDataset` using the `writeDALVersionedKeyValExecution` method.

The `writeInterestedInThriftOutputExecution` function is similar to `writeInterestedInOutputExecution`, but it first converts the `ClustersUserIsInterestedIn` objects to `UserToInterestedInClusters` thrift structs before writing them to HDFS. It takes five arguments: `interestedIn`, `modelVersion`, `interestedInThriftDataset`, `thriftOutputPath`, and `dateRange`. `interestedIn` is a `TypedPipe` of `(UserId, ClustersUserIsInterestedIn)` tuples. `modelVersion` is a string representing the version of the model used to generate the clusters. `interestedInThriftDataset` is a `SnapshotDALDataset[UserToInterestedInClusters]`. `thriftOutputPath` is a string representing the HDFS path to write the output to. Finally, `dateRange` is a `DateRange` object representing the range of dates to write the output for.

The `InterestedInOptOutDailyBatchJob` object is a Scalding job that runs daily and filters out clusters that users have opted out of. It first calls `SimClustersOptOutUtil.getP13nOptOutSources` to get a `TypedPipe` of `(UserId, Set[SemanticCoreEntityId])` tuples representing the semantic entities that each user has opted out of. It then calls `InterestedInSources.simClustersRawInterestedIn2020Source` and `InterestedInSources.simClustersRawInterestedInLite2020Source` to get `TypedPipe`s of `(UserId, ClustersUserIsInterestedIn)` tuples representing the clusters that each user is interested in. Finally, it calls `InferredEntities.getLegibleEntityEmbeddings` to get a `TypedPipe` of `(ClusterId, Seq[SemanticCoreEntityWithScore])` tuples representing the semantic entities associated with each cluster.

The `InterestedInOptOutDailyBatchJob` object then calls `InterestedInOptOut.filterOptedOutInterestedIn` twice, once for the `interestedIn2020Pipe` pipe and once for the `interestedInLite2020Pipe` pipe. It writes the resulting pipes to HDFS using `InterestedInOptOut.writeInterestedInOutputExecution` and `InterestedInOptOut.writeInterestedInThriftOutputExecution`, and performs a sanity check using `SimClustersOptOutUtil.sanityCheckAndSendEmail`. Finally, it prints the counters using `Util.printCounters`.

The `InterestedInOptOutAdhocJob` object is an ad-hoc job that filters out clusters that users have opted out of and prints the differences before and after the opt-out. It takes one argument, `outputDir`, which is a string representing the HDFS path to write the output to. It calls `InterestedInSources.simClustersInterestedInUpdatedSource` to get a `TypedPipe` of `(UserId, ClustersUserIsInterestedIn)` tuples representing the clusters that each user is interested in. It then calls `SimClustersOptOutUtil.getP13nOptOutSources` and `InferredEntities.getLegibleEntityEmbeddings` to get the `optedOutEntities` and `clusterToEntities` pipes. Finally, it calls `InterestedInOptOut.filterOptedOutInterestedIn` and prints the differences before and after the opt-out using `TypedTsv` and `Util.printCounters`.
## Questions: 
 1. What is the purpose of the `filterOptedOutInterestedIn` function?
- The `filterOptedOutInterestedIn` function takes in three `TypedPipe` inputs and returns a `TypedPipe` output. It filters out clusters that a user has opted out of from their interested in clusters.

2. What is the purpose of the `writeInterestedInOutputExecution` function?
- The `writeInterestedInOutputExecution` function takes in three inputs and returns an `Execution` output. It writes the interested in data to HDFS.

3. What is the purpose of the `InterestedInOptOutDailyBatchJob` object?
- The `InterestedInOptOutDailyBatchJob` object is a scheduled execution app that runs daily. It filters out clusters that a user has opted out of from their interested in clusters and writes the interested in data to HDFS. It also performs a sanity check and sends an email if necessary.